# VCを使った認証入門（新人向け）

このドキュメントは、新人エンジニアに**Verifiable Credential（VC）を使った認証**の基本を短時間で理解してもらうための入門資料です。

---

## 目次

1. [まずは5分：VCの基本](#まずは5分vcの基本)
2. [DID基礎とVCとの関係（DIDは必須？代替手段は？）](#did基礎とvcとの関係didは必須代替手段は)
3. [VCで認証はどう行うか（何をどう使う？）](#vcで認証はどう行うか何をどう使う)
4. [認証と認可の関係（違いとVC/OAuthの役割）](#認証と認可の関係違いとvcoauthの役割)
5. [OAuth2 / OIDC / パスキーとの違い](#oauth2--oidc--パスキーとの違い)
6. [具体的な認証ユースケース集](#具体的な認証ユースケース集)
7. [設計の要点と落とし穴（チェックリスト）](#設計の要点と落とし穴チェックリスト)
8. [最小構成のPoC手順（社内向け）](#最小構成のpoc手順社内向け)
9. [用語ミニ辞典](#用語ミニ辞典)
10. [参考規格・仕様（読み物）](#参考規格仕様読み物)
11. [付録：自己署名VC（Self-signed / Self-attested VC）](#付録自己署名vcself-signed--self-attested-vc)

---

## まずは5分：VCの基本

### VCとは？

* **Verifiable Credential**は「検証可能なデジタル証明書」。
* 現実世界の**社員証・免許証・会員証**のデジタル版で、**発行者（Issuer）**が署名し、**保持者（Holder/Wallet）**が**検証者（Verifier/サービス）**へ提示すると、**改ざんされていないこと**や**誰が発行したか**を検証できます。
* **最小主義（データ最小化）**：必要な属性だけ提示（**選択的開示**）が可能。

### 3者モデル

1. **Issuer（発行者）**：大学・企業・行政など。VCを**署名**して発行。
2. **Holder/Wallet（保持者/ウォレット）**：ユーザーの端末/アプリがVCを**保管・提示**。
3. **Verifier（検証者）**：サービス事業者。提示された**VP**（Verifiable Presentation）を検証。

### フォーマットと主な方式

* **W3C VC Data Model 2.0**（枠組み）
* **JWT系**：VC-JWT、**SD-JWT VC**（選択的開示に強い）
* **JSON-LD系**：Data Integrity / BBS+（ゼロ知識的な選択的開示）
* **mDL/mdoc（ISO 18013-5/7）**：運転免許のモバイル版（オフライン提示にも強い）

### 関連プロトコル（交通整理）

* **OIDC4VP**：VCの**提示**をOIDCフローでやりとり
* **OID4VCI**：VCの**発行**を標準化
* **SIOPv2**：ユーザー自身が**自己発行のIDトークン**を返せる拡張。OIDC4VPと組み合わせ可

---

## DID基礎とVCとの関係（DIDは必須？代替手段は？）

### DIDとは

* **Decentralized Identifier**：中央集権的な登録局に依存せず、**識別子 → DIDドキュメント**（公開鍵・検証法・サービスエンドポイント等）へ**解決（resolve）**できる仕組み。
* 代表的なメソッド：`did:web`（HTTPS配下でホスト）、`did:key`（鍵から派生、軽量）、`did:ion`/`did:pkh`など。
* **ペアワイズDID**：サービスごとに異なるDIDを使い分け、**相関リスク**を下げられる。

### VCにDIDは必須？

* **必須ではありません。** W3C VC DM 2.0では、

  * **issuer** は **URI**（`https://...` でも **DID** でも可）。
  * **credentialSubject.id** は **DIDでもURLでも、省略も可**（オフライン資格やmDLなど）。
* 署名検証のための**公開鍵の見つけ方**としてDIDを使うと便利、という位置づけです。

### DIDを使う利点

* **鍵のローテーション/失効**を**DIDドキュメント更新**で表現できる。
* **オフライン検証**や**相互運用**に強い（VC/VPだけで鍵解決の道筋を持てる）。
* **プライバシー配慮**（ペアワイズ）と**分散運用**（レジストリ非依存）。

### DIDを使わない構成（代替）

* **HTTPS + JWKS**：Issuer=`https://id.example.com`、公開鍵は **`/.well-known/jwks.json`** や **OIDC Discovery**。**VC-JWT / SD-JWT VC**と相性◎。
* **X.509系**：**mdoc/mDL**は**証明書チェーン**で信頼を表現（公的CAルート）。
* **固定鍵 / `did:key`**：PoCや閉域で軽量。鍵ローテーションは別経路で管理。

### 選定ガイド（目安）

* 既に**自社ドメイン**と**OIDC運用**がある → **HTTPS+JWKS**が実装容易。
* **相関リスクを強く抑えたい/長期的な脱中央** → **DID（`did:web`から開始）**。
* **公的資格/オフライン提示** → **X.509系（mdoc）**を検討。

---

## VCで認証はどう行うか（何をどう使う？）

### 認証に必要な要素

* **VP（Verifiable Presentation）**：ウォレットが**いま**のログイン要求（`nonce`/`aud`）に結びつけてVCをまとめて署名した提示物。
* **Proof of Possession（鍵の所持証明）**：保持者が**自分の秘密鍵**で署名。**なりすまし・リプレイ**を防止。
* **Subject Binding（主体への結びつき）**：VCが**誰のものか**を鍵や識別子（DID等）で結びつけ。

### 代表的な3パターン

**A. OIDC4VPで“VPログイン”**

1. Verifier（RP）が**認証リクエスト**（QR/リンク）を発行（`nonce`/`state`入り）。
2. Walletが要求に応じて**VCを選択 → VPを生成**（`aud`=RP、`nonce`一致、PoP署名）。
3. RPは**`vp_token` + `presentation_submission`**を受け取り、**署名・失効・発行者**を検証。
4. 条件を満たせば**ログイン成立**（RP側でセッション/ID生成）。

**B. TokenエンドポイントでVPを使う（“VCで認証入力”）**

1. クライアントがTokenエンドポイントへ**VPを添えてリクエスト**。
2. サーバーはVPの**検証結果**に基づき**アクセストークン**を発行（例：社員VC所持で社内API権限付与）。
3. OAuthの**mTLS/DPoP**等で**トークンの持ち出し防止**も併用可能。

**C. パスキー（WebAuthn）とVCの“足し算”**

* **パスキー**で**強い本人性（端末内秘密鍵 + 生体等）**を担保。
* **VC**で**属性や資格**を提示（例：年齢>20、所属=営業部）。
* フィッシング耐性 & 最小開示の両立。

### なぜ“VP”が鍵？

* **`aud`/`nonce`**により**その場限り**の提示に固定。
* **Issuer署名 + Status（失効）確認 + Trust Registry**で**信頼性**を担保。
* **選択的開示**で**必要最小限**の属性のみ提示。

---

## 認証と認可の関係（違いとVC/OAuthの役割）

### 定義の整理

* **認証（Authentication）**：アクセス要求者が**誰か**、あるいは**要求条件を満たすか**を確かめる行為（例：本人鍵の所持証明、所属=営業部）。
* **認可（Authorization）**：認証結果やポリシーに基づき、**何ができるか**（操作・リソース）を決定。

### VCを使うときの分担

1. **認証**：`OIDC4VP`等で**VP**を受け取り、**PoP署名（鍵所持）**と**属性条件**を検証。
2. **権限決定**：検証済みVCの**属性（role, dept, assurance）**を**RBAC/ABAC**で評価。
3. **トークン発行**：必要に応じて**OAuth2**で**access token**を発行し、権限（scope/claims）をエンコード。
4. **トークン束縛**：**DPoP/mTLS**で**盗難耐性**を付与。

### ありがちな落とし穴

* **VC=権限証明と誤解**：VC自体は**属性の証明**。APIアクセスには**短命トークン**へ落とし込むのが実践的。
* **`nonce`/`aud`省略**：VPに**文脈固定**が無いと**リプレイ/なりすまし**の原因に。
* **失効/Status未考慮**：ロール変更や離職が**即時反映**されない。

### 小さな設計例

* ログイン：**OIDC4VP**で「社員VC（有効）」の提示→**セッション確立**。
* API：セッション→**Tokenエンドポイント**で**access token**発行（`scope=read:crm` 等）→**DPoP**で束縛。

---

## OAuth2 / OIDC / パスキーとの違い

| 観点       | VC（OIDC4VP等）          | OIDC（IdPログイン）        | パスキー（WebAuthn/FIDO2）       |
| -------- | --------------------- | -------------------- | -------------------------- |
| 何を証明     | **属性・資格**（発行者署名）      | **IdPでの本人ログイン**      | **端末内鍵の所持 + 生体等**          |
| 依存関係     | **発行者**と**トラスト**      | **IdP**に依存（フェデレーション） | **プラットフォーム/Authenticator** |
| データ最小化   | **選択的開示**が強い          | IdP設計次第              | 属性は基本**持たない**              |
| プライバシー   | **発行者と検証者の分離**で連携最小化  | RP↔IdP間でユーザーの移動可視化   | RPに秘密は渡らないが**属性ゼロ**        |
| フィッシング耐性 | `nonce`/`aud` + 署名で高い | PKCE/回避策あり           | **非常に高い**（Origin束縛）        |
| 持ち運び     | **ウォレット**に保持          | IdPアカウント依存           | 端末/アカウント同期                 |
| 相互補完     | パスキー/ OAuthと**併用が◎**  | VC提示を**受けるRP**にもなれる  | VP署名鍵として**活用可能**           |

> 要点：**VCは「誰がどんな属性を認めたか」を“検証可能”に持ち運ぶ技術**。**OIDCはログイン連携の配線**。**パスキーは強力な鍵ベース本人確認**。用途が重なる部分もあるが、**組み合わせると最強**。

---

## 具体的な認証ユースケース集

1. **年齢確認ログイン**（B2C）

   * 要求属性：**年齢≥20**のみ（生年月日は非開示）。
   * 流れ：RP→OIDC4VPリクエスト→WalletでVC選択→**SD-JWT/BBS+で閾値証明**→ログイン許可。

2. **社内SSO**（Workforce）

   * 社員VC（所属・役職・有効期限）を**OIDC4VP**で提示。合格なら**セッション発行**。
   * APIはアクセストークン＋**権限（Scope/Roles）**を付与。**ローテーション/失効**はStatusリストで管理。

3. **取引先・パートナーの外部SSO**（B2B）

   * 各社が自社Issuer。RPは**Trust Registry**で受入可否を判定。
   * 監査：**どのIssuerのどのスキーマ**でログインしたかを記録。

4. **デバイス/アプリ認証**

   * 組込デバイスへ**Device VC**を発行。起動時に**VP**を提示して**M2M認証**。
   * mTLS/DPoPで**トークン流出対策**を併用。

5. **オフライン施設入館**

   * **mdoc/mDL**でドア端末と**近接通信**。ネット不通でも**署名検証 + 有効期限**で判定。

6. **カスタマー会員証ログイン**

   * 発行：会員登録時に**VC発行（OID4VCI）**。
   * 利用：キャンペーン/サポートで**会員VC提示**→本人特定＋会員種別だけ開示。

---

## 設計の要点と落とし穴（チェックリスト）

**信頼と運用**

* [ ] **Trust Registry**：許容Issuer/スキーマ/ポリシーのリスト運用
* [ ] **Status（失効）**：**Status List 2021**等で**失効/一時停止**を反映
* [ ] **監査ログ**：Issuer・スキーマ・検証結果・`nonce`・`aud`を記録

**セキュリティ**

* [ ] **Challenge**：`nonce`と**`aud`（RP識別）**必須。**リプレイ/転用**防止
* [ ] **PoP署名**：ウォレット鍵でVP署名。**盗難VCの悪用抑止**
* [ ] **トークン束縛**：OAuth連携時は**mTLS/DPoP**でアクセストークンの転用抑止
* [ ] **相関防止**：**ペアワイズDID**や別Keyで**トラッキング抑止**

**プライバシー/UX**

* [ ] **選択的開示**：**SD-JWT**や**BBS+**を採用
* [ ] **回復/乗換**：ウォレットの**バックアップ/復元**手段
* [ ] **同意と可視化**：提示前に**何を出すか**ユーザーに明示

**相互運用**

* [ ] フォーマット（**VC-JWT/SD-JWT/JSON-LD**）と**プロトコル（OIDC4VP/OID4VCI/SIOPv2）**の組み合わせを明示
* [ ] **DID Method**や**did:web/jwks**等の**鍵解決手段**を統一

---

## 最小構成のPoC手順（社内向け）

1. **スキーマ定義**：例「EmployeeCredential（dept, role, exp）」
2. **Issuer**：社内署名鍵を用意。**OID4VCI**で発行APIを実装
3. **Wallet**：モバイル/ブラウザ拡張を準備（社内テスト用）
4. **Verifier（RP）**：

   * OIDC4VPの**認証リクエスト**を発行（`nonce`/`state`）
   * **`vp_token`**受領→**署名・失効・スキーマ**検証→**セッション確立**
5. **Trust Registry/Status**：受入Issuer・スキーマ・失効の**設定/更新**
6. **併用**：社内APIは**OAuth2**と連携し、**DPoP/mTLS**でトークン束縛

> 1スプリントで「**社員VCでの社内ポータルログイン**」を目標にすると学習効率が良いです。

---

## 用語ミニ辞典

* **VC（Verifiable Credential）**：検証可能なデジタル証明書
* **VP（Verifiable Presentation）**：その場で作る提示パッケージ（`aud`/`nonce`で文脈固定）
* **Issuer / Holder / Verifier**：発行者 / 保持者（ウォレット） / 検証者（RP）
* **DID / DID Document**：分散IDと公開鍵メタデータ（※**VCでDIDは必須ではない**。Issuerは`https://`やDIDで表現可、`credentialSubject.id`は**DID/URL/省略**のいずれも可）
* **Trust Registry**：受け入れるIssuer・スキーマ一覧
* **Status（失効）**：VCの有効/失効/一時停止状態
* **SD-JWT / BBS+**：選択的開示（最小限の属性だけ開示）
* **OIDC4VP / OID4VCI / SIOPv2**：提示 / 発行 / 自己発行IDトークンの仕様群
* **DPoP / mTLS**：OAuthのトークン束縛手段

---

## 参考規格・仕様（読み物）

* W3C **Verifiable Credentials Data Model 2.0**
* W3C **DID Core** / **DID Resolution**
* OpenID Foundation **OpenID for Verifiable Presentations (OIDC4VP)**
* OpenID Foundation **OpenID for Verifiable Credential Issuance (OID4VCI)**
* OpenID Foundation **SIOPv2**
* W3C **Verifiable Credential Status List 2021**
* ISO/IEC **18013-5/7（mDL/mdoc）**

---

## 付録：自己署名VC（Self-signed / Self-attested VC）

> ここでは**「自分が持っているデータを自身で署名するVC」**（自己署名VC／自己申告VC）について、用途・注意点・実装の最小レシピをまとめます。

### これは何か（定義）

* **Issuer=Subject**（発行者と主体が同一）のVC。ユーザー自身の鍵で**VC-JWT**や**Data Integrity**に**署名**したクレデンシャル。
* 署名検証はできるが、**「誰が保証した属性か」= 自分**なので、**信頼度（Assurance）は低い**。
* 別名：**Self-signed VC / Self-attested Credential（SAC）**。

### 使いどころ（価値のある場面）

* **ブートストラップ**：最初のアカウント作成で**公開鍵・連絡先**等を提示。
* **ユーザー設定/同意の記録**：利用規約への**同意VC**、通知の**オプトイン**など。
* **鍵・ハンドルのリンク**：PGP鍵、SNSハンドル、ブロックチェーンアドレス（`did:pkh`）等の**自己主張**。
* **学習/PoC**：プロトタイプ段階でデータモデルやフローを検証。

> **やらない方が良い**：KYC/年齢・所属・免許等、**第三者の保証が必要な属性**。コンプライアンス要件を満たせません。

### 検証と信頼の考え方（Verifier視点）

1. **署名検証**：形式・署名・有効期限を検証（VC-JWT/LD-Proofs）。
2. **主体結合（Subject Binding）**：`sub`やDIDが**提示者（Wallet鍵）**と一致するか。
3. **コンテキスト固定**：VPで**`aud`/`nonce`**を要求（リプレイ/転用防止）。
4. **ポリシー判断**：Issuer=Subjectの場合は**Low Assurance**として扱い、**権限を制限**または**補強証拠**を要求。

### 信頼度を高める実践パターン

* **チャレンジ署名**：VCのほかに**サーバー発行のチャレンジ**（`nonce`）へ**同じ鍵で署名**させ、鍵所持を強化。
* **エビデンス添付**：メールOTPの検証結果、SMS確認、WebAuthn Attestationなどを**evidence**フィールドに格納。
* **第三者の追認（カウンター署名）**：後日、信頼できるIssuerが**同内容のVC**を再発行/署名して**昇格**。
* **透明性ログ/タイムスタンプ**：**RFC3161 TSA**や公開ログにハッシュを登録し**後付け改ざんを抑止**。
* **DIDの選択**：`did:web`（ドメイン所有）や`did:pkh`（アドレス所有）等、**所有証明しやすい方法**を採用。

### 最小レシピ（VC-JWTの例）

**Header**

```json
{"alg":"ES256","typ":"JWT","kid":"did:key:z6Mkh...#z6Mkh..."}
```

**Payload（自己署名VC）**

```json
{
  "iss": "did:key:z6Mkh...",            
  "sub": "did:key:z6Mkh...",            
  "nbf": 1730000000,
  "exp": 1732592000,
  "vc": {
    "@context": ["https://www.w3.org/ns/credentials/v2"],
    "type": ["VerifiableCredential","SelfAttestedCredential"],
    "credentialSubject": {
      "id": "did:key:z6Mkh...",
      "contactEmail": "me@example.com",
      "pgpPublicKey": "openpgp4fpr:..."
    }
  }
}
```

**提示（VP-JWT）**：`aud`に検証者、`nonce`にサーバーのチャレンジを入れて**Wallet鍵で署名**。

### RP側の受け入れポリシー例

* [ ] Issuer=Subjectなら**Assurance=Low**。
* [ ] **`aud`/`nonce`必須**、有効期限は短く。
* [ ] **同一鍵のPoP**（チャレンジ署名 or DPoP/WebAuthn）を要求。
* [ ] 重要機能は**別VC（第三者発行）**を追加要求。自己署名VCのみでは**読み取り専用**等に制限。
* [ ] 監査ログ：DID、`kid`、`nonce`、`aud`、ハッシュを記録。

### 関連仕様メモ

* **SIOPv2**：自己発行IDトークン（Self-Issued OP）。自己署名の主張と相性が良いが、**信頼はRPポリシー次第**。
* **OIDC4VP**：自己署名VCも**提示容器（VP）**として運べる。**Trust Registry**で低リスク用途に限定。
* **SD-JWT VC**：自己発行も可能だが**発行者=本人**のため、選択的開示の利点は保ちつつ**保証は低**。

---

### 最後に

* **VCは「属性の信頼」を持ち運ぶ技術**、**OIDCは配線**、**パスキーは強い鍵**。目的に応じて**組み合わせ**ましょう。
* PoCでは**社員VC × OIDC4VP × OAuth連携**が一番学びが多く、プロダクト実装への足場になります。
